<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>API Simulator — SustainAlign</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sblue: '#D7EEF7',
            sblue600: '#3B97C1',
            sgreen: '#E8F8EE',
            sgreen600: '#4FB48E',
            accent: '#6EC5C5'
          }
        }
      }
    };
  </script>

  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, .42);
    }

    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
    }

    pre {
      white-space: pre-wrap;
    }
  </style>
</head>


<body class="min-h-screen bg-gradient-to-b from-sblue to-sgreen text-slate-800 antialiased">

  <div id="nav-slot"></div>

  <main class="max-w-6xl mx-auto p-6 space-y-6">

    <!-- TITLE CARD -->
    <section class="glass p-6 rounded-xl shadow">
      <h1 class="text-2xl font-bold">API Simulator (Mock) — Upgraded Edition</h1>
      <p class="text-sm text-slate-600 mt-1">
        Developer console untuk pengujian modul API SustainAlign.  
        Dilengkapi: <strong>Latency Timer</strong>, <strong>History Log</strong>, <strong>Response Viewer</strong>, dan <strong>Pretty Formatter</strong>.
      </p>
    </section>


    <!-- MAIN PANEL -->
    <section class="grid lg:grid-cols-3 gap-6">

      <!-- LEFT PANEL: ACTION -->
      <div class="col-span-1 glass p-5 rounded-xl shadow space-y-4">

        <h2 class="font-semibold text-lg">API Actions</h2>

        <button id="btnReg" class="px-4 py-2 w-full rounded-lg bg-sblue600 text-white shadow">
          Fetch Mock Regulations
        </button>

        <button id="btnGlobal" class="px-4 py-2 w-full rounded-lg bg-sgreen600 text-white shadow">
          Fetch Global Mapping
        </button>

        <button id="btnValidate" class="px-4 py-2 w-full rounded-lg bg-accent text-white shadow">
          Validate Document
        </button>

        <div class="pt-4 border-t border-white/40">
          <h3 class="font-semibold mb-1">Latency</h3>
          <p id="latency" class="text-sm text-slate-700">— ms</p>
        </div>
      </div>


      <!-- CENTER PANEL: RESPONSE -->
      <div class="col-span-2 glass p-5 rounded-xl shadow">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Response</h2>

          <div class="flex gap-2">
            <button id="viewPretty"
              class="px-3 py-1 text-xs rounded bg-white/60 border">Pretty</button>
            <button id="viewRaw"
              class="px-3 py-1 text-xs rounded bg-white/60 border">Raw</button>
            <button id="expandAll"
              class="px-3 py-1 text-xs rounded bg-white/60 border">Expand</button>
          </div>
        </div>

        <div class="mt-3">
          <pre id="output" class="p-4 bg-white/70 rounded-lg mono text-sm max-h-80 overflow-auto">{}</pre>
        </div>
      </div>

    </section>


    <!-- HISTORY LOG -->
    <section class="glass p-6 rounded-xl shadow">
      <h2 class="font-semibold text-lg">History Log</h2>
      <div id="history" class="mt-3 space-y-2 max-h-60 overflow-auto text-sm"></div>
    </section>

  </main>

  <div id="footer-slot"></div>


  <script type="module">
    import { injectLayout } from "../shared/components.js";
    injectLayout();

    import {
      apiFetchRegulations,
      apiFetchGlobalMapping,
      apiValidateDocument
    } from "./data.js";

    const output = document.getElementById("output");
    const latencyEl = document.getElementById("latency");
    const historyEl = document.getElementById("history");

    function logHistory(label, time, status, payload) {
      const div = document.createElement("div");
      div.className =
        "p-3 rounded bg-white/70 border shadow flex justify-between items-start";

      div.innerHTML = `
        <div>
          <p class="font-semibold">${label}</p>
          <p class="text-xs text-slate-600">${new Date().toLocaleTimeString()}</p>
          <pre class="text-xs mt-1 mono">${JSON.stringify(payload, null, 2)}</pre>
        </div>
        <div class="text-xs text-right">
          <div class="${status === "ok" ? "text-green-600" : "text-red-600"} font-semibold">
            ${status.toUpperCase()}
          </div>
          <div>${time} ms</div>
        </div>
      `;

      historyEl.prepend(div);
    }


    function setResponse(obj) {
      output.textContent = JSON.stringify(obj, null, 2);
    }

    function setRaw(obj) {
      output.textContent = JSON.stringify(obj);
    }


    // BUTTON HANDLERS
    document.getElementById("btnReg").onclick = async () => {
      const start = performance.now();
      const res = await apiFetchRegulations("manufacturing");
      const end = performance.now();

      latencyEl.textContent = (end - start).toFixed(1) + " ms";
      setResponse(res);

      logHistory("Fetch Regulations", (end - start).toFixed(1), "ok", res);
    };

    document.getElementById("btnGlobal").onclick = async () => {
      const start = performance.now();
      const res = await apiFetchGlobalMapping();
      const end = performance.now();

      latencyEl.textContent = (end - start).toFixed(1) + " ms";
      setResponse(res);

      logHistory("Fetch Global Mapping", (end - start).toFixed(1), "ok", res);
    };

    document.getElementById("btnValidate").onclick = async () => {
      const fields = ["emission", "energy"];
      const start = performance.now();
      const res = await apiValidateDocument(fields);
      const end = performance.now();

      latencyEl.textContent = (end - start).toFixed(1) + " ms";
      setResponse(res);

      logHistory("Validate Document", (end - start).toFixed(1), "ok", res);
    };


    // VIEW OPTIONS
    document.getElementById("viewPretty").onclick = () => {
      try { setResponse(JSON.parse(output.textContent)); } catch { }
    };

    document.getElementById("viewRaw").onclick = () => {
      try { setRaw(JSON.parse(output.textContent)); } catch { }
    };

    document.getElementById("expandAll").onclick = () => {
      try {
        const obj = JSON.parse(output.textContent);
        setResponse(obj);
      } catch { }
    };
  </script>
</body>

</html>
